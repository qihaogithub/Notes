### **方案概述：Commander + QuickAdd 实现“一键巡查与更新”**

这个方案的核心思想是：当用户点击 Ribbon 区域的专属 AI 按钮时，脚本会自动"巡查"在最近一段时间内（例如 24 小时内），"资料"文件夹中所有被修改过文件，已经"项目"文件夹中所有被修改过的人工主笔记，找出它们所关联的、需要更新的项目，然后对这些项目**批量执行"智能更新/重写"**。

### **1. 准备工作**

1.  **安装/确认插件**：
    - `QuickAdd`
    - `Commander`
2.  **API 密钥**：确保有可用的 AI 服务 API Key，并已填入脚本文件中。

### **2. 核心脚本与配置 (最佳实践)**

这个工作流的核心是利用 QuickAdd 的“用户脚本功能”，将复杂的业务逻辑（JavaScript 代码）与简单的调用触发器（QuickAdd 宏）分离开，实现更清晰、更易于维护的管理方式。

#### **2.1. 设置 QuickAdd 脚本**

这是让外部脚本生效的关键一步。

1.  **创建脚本文件夹**：在您的 Vault 中创建一个专门用于存放脚本的文件夹，例如 `脚本`。
2.  **配置 QuickAdd**：
    - 进入 Obsidian 设置 → `QuickAdd` 插件。
    - 点击 "Manage Macros" → "Configure"。
    - 添加新宏并配置脚本路径。

#### **2.2. 独立维护的核心脚本 (`.js` 文件)**

所有智能处理逻辑都存放在一个独立的 `.js` 文件中。

- **文件位置**: `模版/脚本/SmartBatchUpdate_AI_Notes.js`
- **核心职责**: 作为整个工作流的智能核心，负责巡查文件、收集信息、调用 AI、更新笔记。

#### **2.3. 脚本核心功能详解**

##### **2.3.1 配置参数**

```javascript
const AI_MODEL = "deepseek-ai/DeepSeek-V3.1"; // AI 模型选择
const OPENAI_API_KEY = "ms-b92ab3ed-c924-4579-a624-7acf67ac01ac"; // API 密钥
const openAI_URL = "https://api-inference.modelscope.cn/v1/chat/completions"; // API 地址
const LOOKBACK_HOURS = 24; // 巡查范围：最近 24 小时内修改过的文件
```

##### **2.3.2 巡查逻辑**

脚本会自动查找两类文件：

1. **源文档**：位于 `资料/` 文件夹，最近 24 小时内修改过，且包含 `projects` 字段的文件
2. **项目主笔记**：位于 `项目/` 文件夹，最近 24 小时内修改过，且不是 AI 笔记本身（不以 `_AI.md` 结尾）

##### **2.3.3 信息收集与处理**

1. **关联项目收集**：从源文档的 `projects` 字段中提取关联的项目路径
2. **源文档聚合**：使用 Dataview 查询获取项目的所有关联源文档
3. **内容整合**：将项目主笔记和所有关联源文档的内容整合为 AI 输入

##### **2.3.4 AI 生成与更新**

1. **结构化提示**：AI 会按照标准结构生成笔记（背景与目标、相关人员、关键过程等）
2. **YAML frontmatter 处理**：
   - 自动继承项目主笔记的 YAML 字段
   - 支持数组的正确格式（如 Stakeholders 和 tags）
   - 时间戳精确到分钟（ISO 格式）
3. **内容更新**：保留旧笔记中的有效信息，整合新信息，生成完整的新笔记

#### **2.4. 配置 QuickAdd 宏**

在 QuickAdd 中创建一个宏来调用脚本。

- **宏名称**: `一键更新AI笔记`
- **配置**: 添加用户脚本并选择 `SmartBatchUpdate_AI_Notes.js`

### **3. 使用 Commander 添加 Ribbon 按钮**

现在，我们将把 QuickAdd 宏，变成一个触手可及的按钮。

1.  **打开 Commander 设置**：进入 Obsidian 设置 → 左侧找到 "Commander" 插件。
2.  **选择添加位置**：在 Commander 的设置界面，点击顶部的 "左侧边栏" 选项卡。
3.  **添加新命令**：
    - 点击 "**Add Command**" 按钮。
    - 在弹出的搜索框中，**搜索 QuickAdd 宏的名称**：`一键更新AI笔记`。
    - 点击选中 `QuickAdd: 一键更新AI笔记` 这个命令。
4.  **自定义按钮外观**：
    - **Name**：给按钮起个名字，例如 `一键更新所有AI笔记`。
    - **Icon**：选择一个图标，如 `brain-circuit` (大脑回路), `wand` (魔杖) 或 `refresh-cw` (刷新)。
5.  **完成**：关闭设置。您会立刻在 Obsidian 窗口最左侧的 Ribbon 区域看到刚刚创建的图标按钮！

### **4. YAML frontmatter 格式规范**

AI 笔记会自动生成符合规范的 YAML frontmatter：

```yaml
---
created: 2025-09-20T00:04:00
updated: 2025-09-20T14:23:00
status: #AI生成
projects:
Parent_project:
Stakeholders:
  - 产品-子航
  - UI-祁昊
tags:
  - AI笔记
---
```

### **5. AI 笔记内容结构**

AI 生成的笔记会遵循以下标准结构：

```markdown
# 项目标题

## 📅 背景与目标

## 👥 相关人员

## 🔄 关键过程

## ⚠️ 风险摘要

## 📌 待办汇总

## 🏁 结果与复盘

## 🔗 相关文档
```

### **工作流程**

1.  **自由创作**：可以在一天中的任何时候，创建或修改 `资料/` 文件夹下的任意多个会议纪要、周报等。
2.  **一键触发**：在用户觉得合适的时候（例如下班前、午休后），**只需点击一下左侧 Ribbon 区域的那个大脑图标按钮**。
3.  **自动执行**：脚本会自动在后台运行：
    - 查找过去 24 小时内所有被动过的源文档和项目主笔记
    - 通过 Dataview 查询获取所有关联文档
    - 调用 AI 生成结构化的新笔记
    - 更新 AI 笔记文件，保留有效信息
4.  **接收反馈**：会通过 Obsidian 右上角的弹窗提示，实时了解进度，例如"发现 3 个项目需要更新..."、"正在处理项目 A..."、"全部完成！"。

### **6. 智能重复处理保护机制**

为了解决重复处理的问题，脚本实现了智能的重复处理保护机制：

#### **6.1 处理时间戳记录**

- 每次成功处理项目后，会在 AI 笔记的 YAML frontmatter 中添加 `last_processed` 字段
- 该字段记录 ISO 格式的处理时间戳，精确到毫秒

#### **6.2 智能过滤逻辑**

脚本会自动过滤掉不需要重复处理的项目：

1. **新项目检测**：如果没有对应的 AI 笔记，肯定需要处理
2. **时间比较**：只有当源文件的修改时间晚于 AI 笔记的最后处理时间时才进行处理
3. **精确匹配**：只处理真正有更新的项目，避免不必要的 API 调用

#### **6.3 更新后的 YAML frontmatter 格式**

```yaml
---
created: 2025-09-20T00:04:00
updated: 2025-09-20T14:23:00
last_processed: 2025-09-20T14:23:45.123Z # 新增：最后处理时间
status: #AI生成
projects:
Parent_project:
Stakeholders:
  - 产品-子航
  - UI-祁昊
tags:
  - AI笔记
---
```

#### **6.4 优势**

- **避免重复处理**：已经处理过的项目不会再次处理，节省 API 调用次数
- **智能识别**：只有当源文件有真正更新时才触发处理
- **透明可查**：通过 `last_processed` 字段可以清楚地看到每个项目的最后处理时间
- **资源优化**：减少不必要的计算和网络请求，提高整体效率

### **7. 使用建议**

1. **定期执行**：建议每天下班前或需要整理项目信息时执行一次
2. **查看处理记录**：可以通过查看 AI 笔记的 `last_processed` 字段了解处理历史
3. **手动触发**：如果需要强制重新处理某个项目，可以手动删除对应的 `last_processed` 字段

这个方案将 AI 的强大能力无缝集成到了 Obsidian 的原生体验中，真正做到了"召之即来，挥之即去"的境界，完美符合用户对效率和稳定性的极致追求。
