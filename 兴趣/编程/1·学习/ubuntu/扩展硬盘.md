# Linux 硬盘扩容指南

## 一、实例：扩容根分区 sda2

当前硬盘情况：

```
root@qihao-Standard-PC-i440FX-PIIX-1996:~# sudo fdisk -l /dev/sda
Disk /dev/sda：64 GiB，68719476736 字节，134217728 个扇区
设备        起点     末尾     扇区 大小 类型
/dev/sda1   2048     4095     2048   1M BIOS 启动
/dev/sda2   4096 67106815 67102720  32G Linux 文件系统
```

### 问题分析

1. sda2 是根分区（/），正在使用中
2. 文件系统类型是 ext4
3. 存在 GPT 分区表问题需要修复
4. 有未使用空间可以扩容

### 解决方案一：使用 parted（推荐，更安全）

1. 修复 GPT 分区表：

```bash
# 使用 gdisk 修复 GPT 分区表
sudo gdisk /dev/sda
# 在提示符下输入 w 来写入修复，然后输入 Y 确认
```

2. 使用 parted 进行在线扩容：

```bash
sudo parted /dev/sda
# 在 parted 提示符下执行：
print    # 查看当前分区情况
resizepart 2 100%    # 将分区 2 扩展到磁盘末尾
quit
```

3. 刷新分区表：

```bash
sudo partprobe /dev/sda
```

4. 扩展文件系统：

```bash
sudo resize2fs /dev/sda2
```

5. 验证结果：

```bash
df -h
```

下面是实际操作

```
root@qihao-Standard-PC-i440FX-PIIX-1996:~# sudo gdisk /dev/sda
GPT fdisk (gdisk) version 1.0.10

Partition table scan:
  MBR: protective
  BSD: not present
  APM: not present
  GPT: present

Found valid GPT with protective MBR; using GPT.

Command (? for help): w
Warning! Secondary header is placed too early on the disk! Do you want to
correct this problem? (Y/N): y
Have moved second header and partition table to correct location.

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): y
OK; writing new GUID partition table (GPT) to /dev/sda.
Warning: The kernel is still using the old partition table.
The new table will be used at the next reboot or after you
run partprobe(8) or kpartx(8)
The operation has completed successfully.
root@qihao-Standard-PC-i440FX-PIIX-1996:~# sudo parted /dev/sda
GNU Parted 3.6
使用 /dev/sda
欢迎使用 GNU Parted！输入 'help' 来查看命令列表。
(parted) print                                                            
警告: 并非所有可用于 /dev/sda 的空间都被用到了，您可以修正 GPT 以使用所有的空间 (额外的 2014 个区块)，还是说要继续使用目前的设置？ 
修正/Fix/忽略/Ignore? resizepart 2 100%                                   
parted: 无效的字组：resizepart
修正/Fix/忽略/Ignore? fix                                                 
型号：QEMU QEMU HARDDISK (scsi)
磁盘 /dev/sda: 68.7GB
扇区大小 (逻辑/物理)：512B/512B
分区表：gpt
磁盘标志：

编号  起始点  结束点  大小    文件系统  名称  标志
 1    1049kB  2097kB  1049kB                  bios_grub
 2    2097kB  34.4GB  34.4GB  ext4

(parted) resizepart 2 100%                                                
警告: 分区 /dev/sda2 正被使用。你确定要继续吗?
是/Yes/否/No? yes
(parted)  quit                                                            
信息: 你可能需要 /etc/fstab。

root@qihao-Standard-PC-i440FX-PIIX-1996:~# sudo partprobe /dev/sda        
root@qihao-Standard-PC-i440FX-PIIX-1996:~# sudo resize2fs /dev/sda2
resize2fs 1.47.0 (5-Feb-2023)
/dev/sda2 上的文件系统已被挂载于 /；需要进行在线调整大小
old_desc_blocks = 4, new_desc_blocks = 8
/dev/sda2 上的文件系统大小已经调整为 16776699 个块（每块 4k）。

root@qihao-Standard-PC-i440FX-PIIX-1996:~# df -h
文件系统        大小  已用  可用 已用% 挂载点
tmpfs           795M  1.6M  793M    1% /run
/dev/sda2        63G   27G   34G   44% /
tmpfs           3.9G   20K  3.9G    1% /dev/shm
tmpfs           5.0M     0  5.0M    0% /run/lock
/dev/sdb1       483G  2.8M  458G    1% /mnt/hhd-500g
tmpfs           795M   96K  795M    1% /run/user/120
tmpfs           795M   88K  795M    1% /run/user/1000

```

### 解决方案二：使用 fdisk（适用于非根分区）

【安全说明】

- 此方法虽然安全（不会丢失数据），但建议仅用于非根分区
- 删除分区表项不会删除实际数据
- 必须使用相同的起始扇区
- 操作前建议备份重要数据

具体步骤：

1. 记录原始分区信息：

```bash
sudo fdisk -l /dev/sda
df -T /dev/sda2
```

2. 重建分区：

```bash
sudo fdisk /dev/sda
# 依次执行：
p    # 打印分区表，记住起始扇区
d    # 删除分区
2    # 选择分区号
n    # 新建分区
p    # 主分区
2    # 分区号
XXXX # 输入原始起始扇区
     # 结束扇区直接回车
N    # 不删除签名
w    # 保存退出
```

3. 更新分区表并扩展文件系统：

```bash
sudo partprobe /dev/sda
sudo resize2fs /dev/sda2  # 对于 ext4
# 或
sudo xfs_growfs /mount_point  # 对于 xfs
```

## 二、通用硬盘扩展说明

### 1. 查看硬盘信息

- 使用命令 `lsblk` 查看当前的硬盘和分区信息
- 使用 `df -h` 查看磁盘使用情况
- 使用 `fdisk -l` 查看详细的磁盘信息

### 2. 添加新硬盘

- 物理上连接新的硬盘到计算机
- 使用 `lsblk` 或 `fdisk -l` 确认系统识别到了新的硬盘

### 3. 分区新硬盘

- 使用 `fdisk` 或 `parted` 对新硬盘进行分区
- 例如，使用 `fdisk /dev/sdX`，然后按照提示创建新分区：
  - 输入 `n` 创建新分区
  - 输入 `p` 选择主分区
  - 输入分区号（1-4）
  - 设置起始扇区（默认回车）
  - 设置结束扇区（默认回车，使用全部空间）
  - 输入 `w` 保存更改并退出

### 4. 格式化新分区

- 使用 `mkfs` 命令格式化新分区，例如：`mkfs.ext4 /dev/sdX1`
- 对于不同的文件系统，可以使用：
  - ext4: `mkfs.ext4 /dev/sdX1`
  - xfs: `mkfs.xfs /dev/sdX1`
  - btrfs: `mkfs.btrfs /dev/sdX1`

### 5. 挂载新分区

- 创建一个挂载点：`mkdir /mnt/newdisk`
- 挂载分区：`mount /dev/sdX1 /mnt/newdisk`
- 验证挂载：`df -h`

### 6. 更新 /etc/fstab

- 获取分区的 UUID：`blkid /dev/sdX1`
- 编辑 `/etc/fstab` 文件：`nano /etc/fstab`
- 添加以下格式的行：

  ```
  UUID=<分区UUID> /mnt/newdisk ext4 defaults 0 2
  ```

### 7. LVM 卷扩容

1. 扩展物理卷：`pvresize /dev/sdX1`
2. 扩展逻辑卷：`lvextend -l +100%FREE /dev/mapper/vg-lv`
3. 调整文件系统大小：
   - ext4：`resize2fs /dev/mapper/vg-lv`
   - xfs：`xfs_growfs /mount_point`

### 注意事项

- 进行任何分区操作前请务必备份重要数据
- sdX 中的 X 需要替换为实际的盘符（如 sda、sdb 等）
- 所有命令都需要 root 权限执行
- 扩容操作有风险，建议在操作前仔细确认命令参数
